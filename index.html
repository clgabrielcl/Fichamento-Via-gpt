<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Fichamento por DOI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .glass { background: linear-gradient(135deg, rgba(255,255,255,0.7), rgba(255,255,255,0.55)); backdrop-filter: blur(6px); }
    .card { transition: transform .12s ease, box-shadow .12s ease; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(2,6,23,0.12); }
    textarea { resize: vertical; }
    .abnt { font-style: italic; }
  </style>
</head>
<body class="bg-gradient-to-br from-sky-50 to-indigo-50 min-h-screen text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold">Simulador de Fichamento de Artigos (por DOI)</h1>
        <p class="text-sm text-slate-600 mt-1">Coloque o DOI, puxe os metadados e crie fichamentos claros, elegíveis e exportáveis em PDF.</p>
      </div>
      <div class="text-right">
        <button id="exportAllPdf" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:opacity-95">Exportar todos (PDF)</button>
        <button id="exportJson" class="ml-2 border border-indigo-600 text-indigo-700 px-3 py-2 rounded-lg">Exportar JSON</button>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="glass p-4 rounded-2xl card">
        <label class="text-sm font-semibold">DOI do artigo</label>
        <div class="mt-2 flex gap-2">
          <input id="doiInput" type="text" placeholder="ex: 10.1038/s41586-020-2649-2" class="flex-1 px-3 py-2 rounded-lg border" />
          <button id="fetchBtn" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Buscar</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Busca metadados via CrossRef. Se o artigo tiver resumo público, será carregado.</p>
      </div>

      <div class="glass p-4 rounded-2xl card md:col-span-2">
        <label class="text-sm font-semibold">Rascunho rápido</label>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input id="titleInput" placeholder="Título" class="px-3 py-2 rounded-lg border" />
          <input id="authorsInput" placeholder="Autores (separados por ;)" class="px-3 py-2 rounded-lg border" />
          <input id="journalInput" placeholder="Periódico" class="px-3 py-2 rounded-lg border" />
          <input id="yearInput" placeholder="Ano" class="px-3 py-2 rounded-lg border" />
        </div>
        <div class="mt-3">
          <textarea id="abstractInput" rows="3" placeholder="Resumo / Abstract" class="w-full px-3 py-2 rounded-lg border"></textarea>
        </div>
        <div class="mt-3 flex gap-2">
          <select id="eligibility" class="px-3 py-2 rounded-lg border">
            <option value="eligible">Elegível</option>
            <option value="maybe">Talvez / Parcial</option>
            <option value="not">Não elegível</option>
          </select>
          <input id="keywordsInput" placeholder="Palavras-chave (vírgula)" class="px-3 py-2 rounded-lg border flex-1" />
          <button id="addToList" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Adicionar à lista</button>
        </div>
      </div>
    </section>

    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3">Lista de fichamentos</h2>
      <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <p id="emptyNote" class="text-sm text-slate-500 mt-4">Nenhum fichamento ainda. Busque um DOI e clique em "Adicionar à lista".</p>
    </section>

    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-3">Ações rápidas</h2>
      <div class="flex flex-wrap gap-3">
        <button id="clearAll" class="px-4 py-2 rounded-lg border">Limpar tudo</button>
        <button id="downloadPdfSelected" class="px-4 py-2 rounded-lg bg-amber-500 text-white">Exportar selecionados (PDF)</button>
        <button id="copyJson" class="px-4 py-2 rounded-lg border">Copiar JSON para área</button>
      </div>
    </section>

    <footer class="text-xs text-slate-500 mt-8">Feito para pesquisadores e criadores de conteúdo — interface simples e exportável. Sugestões? Me peça alterações!</footer>
  </div>

  <template id="cardTemplate">
    <div class="p-4 glass rounded-2xl card">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-sm text-slate-500">DOI: <span class="doiText"></span></div>
          <h3 class="title font-semibold text-lg mt-1"></h3>
          <div class="text-sm text-slate-600 authors mt-1"></div>
        </div>
        <div class="text-right">
          <div class="text-sm yearText"></div>
          <div class="mt-2 flex gap-2">
            <button class="abntBtn px-2 py-1 border rounded text-xs">Gerar ABNT</button>
            <button class="pdfBtn px-2 py-1 bg-indigo-600 text-white rounded text-xs">PDF</button>
            <button class="removeBtn px-2 py-1 border rounded text-xs">Remover</button>
          </div>
        </div>
      </div>
      <p class="mt-3 text-sm abstractText text-slate-700"></p>
      <div class="mt-3 text-sm">
        <strong>Palavras-chave:</strong> <span class="keywords"></span>
      </div>
      <div class="mt-2 flex items-center justify-between">
        <div>
          <label class="text-xs text-slate-500">Elegibilidade</label>
          <div class="eligibilityBadge mt-1 inline-block px-2 py-1 rounded text-xs font-semibold"></div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Notas</label>
          <div><textarea class="notes mt-1 px-2 py-1 rounded border" rows="2" placeholder="Observações"></textarea></div>
        </div>
      </div>
      <div class="mt-3 flex items-center justify-between">
        <div class="abntArea text-sm text-slate-600"></div>
        <div>
          <label class="text-xs text-slate-500">Selecionar</label>
          <div><input type="checkbox" class="selectBox mt-1" /></div>
        </div>
      </div>
    </div>
  </template>

<script>
// Helpers
function q(sel, root=document){ return root.querySelector(sel); }
function qAll(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

// Storage key
const STORAGE_KEY = 'fichamentos_v1';

// Elements
const doiInput = q('#doiInput');
const fetchBtn = q('#fetchBtn');
const addToListBtn = q('#addToList');
const cardsContainer = q('#cards');
const emptyNote = q('#emptyNote');
const titleInput = q('#titleInput');
const authorsInput = q('#authorsInput');
const journalInput = q('#journalInput');
const yearInput = q('#yearInput');
const abstractInput = q('#abstractInput');
const keywordsInput = q('#keywordsInput');
const eligibilitySel = q('#eligibility');
const exportAllPdf = q('#exportAllPdf');
const exportJson = q('#exportJson');
const clearAll = q('#clearAll');
const downloadPdfSelected = q('#downloadPdfSelected');
const copyJson = q('#copyJson');

let fichamentos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(fichamentos)); }

function render(){
  cardsContainer.innerHTML = '';
  if(fichamentos.length===0){ emptyNote.style.display='block'; return; }
  emptyNote.style.display='none';
  fichamentos.forEach((f, idx)=>{
    const tpl = document.getElementById('cardTemplate');
    const node = tpl.content.cloneNode(true);
    node.querySelector('.doiText').textContent = f.doi || '-';
    node.querySelector('.title').textContent = f.title || 'Título não informado';
    node.querySelector('.authors').textContent = f.authors || '';
    node.querySelector('.abstractText').textContent = f.abstract || '';
    node.querySelector('.keywords').textContent = (f.keywords||[]).join(', ');
    node.querySelector('.yearText').textContent = f.year||'';
    const badge = node.querySelector('.eligibilityBadge');
    if(f.eligibility==='eligible'){ badge.textContent='Elegível'; badge.classList.add('bg-emerald-100','text-emerald-700'); }
    else if(f.eligibility==='maybe'){ badge.textContent='Talvez'; badge.classList.add('bg-amber-100','text-amber-700'); }
    else { badge.textContent='Não elegível'; badge.classList.add('bg-rose-100','text-rose-700'); }
    const notesEl = node.querySelector('.notes'); notesEl.value = f.notes||'';
    const abntArea = node.querySelector('.abntArea');

    node.querySelector('.abntBtn').addEventListener('click', ()=>{
      abntArea.innerHTML = '<span class="abnt">'+generateABNT(f)+'</span>';
    });
    node.querySelector('.pdfBtn').addEventListener('click', ()=>{
      exportCardPdf(f, idx);
    });
    node.querySelector('.removeBtn').addEventListener('click', ()=>{
      if(confirm('Remover este fichamento?')){ fichamentos.splice(idx,1); save(); render(); }
    });
    notesEl.addEventListener('input', (e)=>{ fichamentos[idx].notes = e.target.value; save(); });
    node.querySelector('.selectBox').addEventListener('change', (e)=>{ fichamentos[idx].selected = e.target.checked; save(); });

    cardsContainer.appendChild(node);
  });
}

function generateABNT(f){
  // Simple ABNT approximation: AUTOR(ES). Título: subtítulo (se houver). Periódico, v., n., p., ano.
  const authors = (f.authors||'').split(';').map(a=>a.trim()).filter(Boolean);
  let authorStr = authors.length>0 ? authors.map(a=> a.toUpperCase()).join(' ; ') : '';
  let title = f.title || '';
  let journal = f.journal || '';
  let year = f.year || '';
  const abnt = `${authorStr} ${authorStr?'.':''} ${title}${title?'.':''} ${journal?journal+'.':''} ${year}`;
  return abnt.replace(/\s+/g,' ').trim();
}

// Export single card to PDF
function exportCardPdf(f, idx){
  const el = document.createElement('div');
  el.style.padding='20px'; el.style.fontFamily='Arial, Helvetica, sans-serif';
  el.innerHTML = `<h2>${f.title||'Título'}</h2><p><strong>Autores:</strong> ${(f.authors||'')}</p><p><strong>DOI:</strong> ${f.doi||''}</p><p><strong>Periódico:</strong> ${f.journal||''} — ${f.year||''}</p><hr><p><strong>Resumo:</strong><br>${(f.abstract||'')}</p><hr><p><strong>Elegibilidade:</strong> ${f.eligibility||''}</p><p><strong>Palavras-chave:</strong> ${(f.keywords||[]).join(', ')}</p><p><strong>Notas:</strong><br>${f.notes||''}</p>`;
  html2pdf().from(el).set({margin:10, filename:(f.title||'fichamento')+'.pdf', html2canvas:{scale:1.5}}).save();
}

// Export all to one PDF
exportAllPdf.addEventListener('click', ()=>{
  if(fichamentos.length===0){ alert('Nada para exportar'); return; }
  const wrapper = document.createElement('div');
  wrapper.style.padding='20px'; wrapper.style.fontFamily='Arial, Helvetica, sans-serif';
  fichamentos.forEach((f, i)=>{
    const sec = document.createElement('section');
    sec.style.pageBreakAfter='always';
    sec.innerHTML = `<h2 style="font-size:18px;margin-bottom:6px;">${i+1}. ${f.title||'Título'}</h2><p><strong>Autores:</strong> ${(f.authors||'')}</p><p><strong>DOI:</strong> ${f.doi||''}</p><p><strong>Periódico:</strong> ${f.journal||''} — ${f.year||''}</p><p><strong>Resumo:</strong><br>${(f.abstract||'')}</p><p><strong>Elegibilidade:</strong> ${f.eligibility||''}</p><p><strong>Palavras-chave:</strong> ${(f.keywords||[]).join(', ')}</p><p><strong>Notas:</strong><br>${f.notes||''}</p>`;
    wrapper.appendChild(sec);
  });
  html2pdf().from(wrapper).set({margin:10, filename:'fichamentos_coletivos.pdf', html2canvas:{scale:1.5}}).save();
});

// Export selected to PDF
downloadPdfSelected.addEventListener('click', ()=>{
  const selected = fichamentos.filter(f=>f.selected);
  if(selected.length===0){ alert('Nenhum fichamento selecionado. Marque os itens que deseja exportar.'); return; }
  const wrapper = document.createElement('div'); wrapper.style.padding='20px'; wrapper.style.fontFamily='Arial, Helvetica, sans-serif';
  selected.forEach((f,i)=>{ const sec = document.createElement('section'); sec.style.pageBreakAfter='always'; sec.innerHTML = `<h2 style="font-size:18px;margin-bottom:6px;">${i+1}. ${f.title||'Título'}</h2><p><strong>Autores:</strong> ${(f.authors||'')}</p><p><strong>DOI:</strong> ${f.doi||''}</p><p><strong>Periódico:</strong> ${f.journal||''} — ${f.year||''}</p><p><strong>Resumo:</strong><br>${(f.abstract||'')}</p><p><strong>Elegibilidade:</strong> ${f.eligibility||''}</p><p><strong>Palavras-chave:</strong> ${(f.keywords||[]).join(', ')}</p><p><strong>Notas:</strong><br>${f.notes||''}</p>`; wrapper.appendChild(sec); });
  html2pdf().from(wrapper).set({margin:10, filename:'fichamentos_selecionados.pdf', html2canvas:{scale:1.5}}).save();
});

// Export JSON
exportJson.addEventListener('click', ()=>{
  const dataStr = JSON.stringify(fichamentos, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='fichamentos.json'; a.click(); URL.revokeObjectURL(url);
});

copyJson.addEventListener('click', ()=>{ navigator.clipboard.writeText(JSON.stringify(fichamentos,null,2)).then(()=>alert('JSON copiado para área de transferência')); });

clearAll.addEventListener('click', ()=>{ if(confirm('Limpar todos os fichamentos salvos?')){ fichamentos=[]; save(); render(); } });

// Add to list
addToListBtn.addEventListener('click', ()=>{
  const entry = {
    doi: doiInput.value.trim() || null,
    title: titleInput.value.trim() || null,
    authors: authorsInput.value.trim() || null,
    journal: journalInput.value.trim() || null,
    year: yearInput.value.trim() || null,
    abstract: abstractInput.value.trim() || null,
    keywords: keywordsInput.value.split(',').map(k=>k.trim()).filter(Boolean),
    eligibility: eligibilitySel.value,
    notes: '',
    selected: false
  };
  fichamentos.unshift(entry);
  save(); render();
});

// Fetch DOI -> CrossRef
fetchBtn.addEventListener('click', async ()=>{
  const doi = doiInput.value.trim();
  if(!doi){ alert('Insira um DOI válido'); return; }
  const cleanDoi = doi.replace(/^https?:\/\//,'').replace(/^doi:/i,'');
  const url = `https://api.crossref.org/works/${encodeURIComponent(cleanDoi)}`;
  fetchBtn.disabled = true; fetchBtn.textContent='Buscando...';
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('Não encontrado');
    const data = await res.json();
    const item = data.message;
    // Map fields
    titleInput.value = Array.isArray(item.title)?item.title[0]:item.title||'';
    authorsInput.value = (item.author||[]).map(a=>[a.family, a.given].filter(Boolean).join(', ')).join(' ; ');
    journalInput.value = (item['container-title'] && item['container-title'][0]) || item['publisher'] || '';
    yearInput.value = (item['issued'] && item['issued']['date-parts'] && item['issued']['date-parts'][0] && item['issued']['date-parts'][0][0]) || '';
    abstractInput.value = item.abstract ? stripHtmlTags(item.abstract) : '';
    keywordsInput.value = (item.subject||[]).slice(0,6).join(', ');
    alert('Metadados carregados. Revise os campos e clique em "Adicionar à lista".');
  }catch(err){
    alert('Erro ao buscar o DOI: '+err.message);
  }finally{ fetchBtn.disabled=false; fetchBtn.textContent='Buscar'; }
});

function stripHtmlTags(html){ return html.replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim(); }

// Save on unload
window.addEventListener('beforeunload', ()=> save());

// Initial render
render();
</script>
</body>
</html>
